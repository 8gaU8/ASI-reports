\begin{lstlisting}[language=python, caption=White correction for Nuance Cmaera with large reference, label={code:wc-nuance-large}]
import numpy as np
from matplotlib import pyplot as plt

from asi import path_config
from asi.draw import draw_multi_crosss, reconstruct_rgb, select_area
from asi.io.load_nuance import load_nuance_image

session1 = path_config.measurements / "session1"
nuance = session1 / "Nuance"

# White correction with large reference

# load white image

root = nuance / "white 2lights"

white_image, wavelengths = load_nuance_image(root)
white_image = white_image.astype(np.float64)


fig, axes = plt.subplots(1, 2, figsize=(10, 5))

white_pos = (slice(200, 1000), slice(200, 1200))


white_rgb = reconstruct_rgb(white_image, wavelengths)
white_rgb = select_area(white_rgb, white_pos)
white_rgb /= white_rgb.max()
white_rgb = white_rgb.clip(0, 1)
axes[0].imshow(white_rgb)
axes[0].set_title("Before white correction")


# White correction with selected area
white_sq = white_image[white_pos]

# replace nonzero elements with minimum value
nonzero_elements = white_sq[white_sq != 0]
min_elm = nonzero_elements.min()
white_sq = white_sq.clip(min_elm, None)


# load spectral image
root = nuance / "colorchecker 2lights"
spectral_image, wavelengths = load_nuance_image(root)

# apply white correction
whiteref = white_sq.mean((0, 1))
white_corrected = spectral_image / whiteref
white_corrected /= white_corrected.max()
white_corrected = white_corrected.clip(0, 1)
del white_rgb

white_corrected_rgb_view = reconstruct_rgb(white_corrected, wavelengths)
axes[1].imshow(white_corrected_rgb_view)
axes[1].set_title("After white correction")

plt.show()

# Show spectra
colors = ["g", "r", "b"]
color_names = ["green", "red", "blue"]
positions = [(300, 500), (500, 500), (1100, 600)]


plt.rcParams["figure.dpi"] = 100
fig, axes = plt.subplots(2, 4, figsize=(10, 5), tight_layout=True)
print(axes)

axes1, axes2 = axes
for pos, color, color_name, ax in zip(positions, colors, color_names, axes2):
    print(ax)
    ax.plot(wavelengths, white_corrected[pos[1], pos[0], :], color=color)
    ax.set_title(f"Spectla at {color_name}(corrected)")
    ax.set_xlabel("Wavelength[nm]")

for pos, color, color_name, ax in zip(positions, colors, color_names, axes1):
    print(ax)
    ax.plot(wavelengths, spectral_image[pos[1], pos[0], :], color=color)
    ax.set_title(f"Spectla at {color_name}(original)")
    ax.set_xlabel("Wavelength[nm]")


axes1[-1].plot(wavelengths, whiteref, color="k")
axes1[-1].set_title("White reference")
axes1[-1].set_xlabel("Wavelength[nm]")

canvas = draw_multi_crosss(white_corrected_rgb_view, positions)
axes2[-1].imshow(canvas)
axes2[-1].set_title("RGB view")

plt.show()

\end{lstlisting}
